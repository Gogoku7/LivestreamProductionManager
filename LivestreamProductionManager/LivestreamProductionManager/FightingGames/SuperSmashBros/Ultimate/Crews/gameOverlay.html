<!DOCTYPE html>
<html>
	<head>
        <link rel="stylesheet" type="text/css" href="CSS/Styles.css">
        <link rel="stylesheet" type="text/css" href="CSS/Content.css">
		<script src="../../JavaScript/jQuery.js"></script>
        <script src="../../JavaScript/fitty.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <div class="tournamentInfo">
                <div class="info" id="infoRound">
                    <div class="infoBox" id="infoRoundBox">
                        <span class="boxText">
                            <span id="roundText"></span>
                            <span> / </span>
                            <span id="bestOfText"></span>
                        </span>
                    </div>
                </div>

                <div class="info" id="infoTournament">
                    <div class="infoBox" id="infoTournamentBox">
                        <span class="boxText">
                            <span id="tournamentText"></span>
                            <span> / </span>
                            <span id="extraText"></span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="crews">
                <div class="crew" id="crew1">
                    <div class="crewBox" id="crew1Box">
                        <div class="crewRow" id="crew1Row0">
                            <div class="crewScoreBox" id="crew1ScoreBox">
                                <div class="crewScoreContainer" id="crew1ScoreContainer">
									<span class="crewStocksLeft" id="crew1StocksLeftText"></span>
								</div>
                            </div>
                            <div class="crewNameBox" id="crew1NameBox">
                                <div class="crewNameContainer" id="crew1NameContainer">
                                    <span class="crewName" id="crew1NameText"></span>
                                </div>
                            </div>
                            <div class="crewPort" id="crew1Port">
                                <div class="crewCharacter" id="crew1Character"></div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew1Row1">
                            <div class="crewPlayerBox" id="crew1Player1Box">
                                <div class="crewPlayerNameContainer" id="crew1Player1NameContainer">
                                    <span class="crewPlayerName crew1Player1Active crew1Player1Eliminated" id="crew1Player1NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew1Row2">
                            <div class="crewPlayerBox" id="crew1Player2Box">
                                <div class="crewPlayerNameContainer" id="crew1Player2NameContainer">
                                    <span class="crewPlayerName crew1Player2Active crew1Player2Eliminated" id="crew1Player2NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew1Row3">
                            <div class="crewPlayerBox" id="crew1Player3Box">
                                <div class="crewPlayerNameContainer" id="crew1Player3NameContainer">
                                    <span class="crewPlayerName crew1Player3Active crew1Player3Eliminated" id="crew1Player3NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew1Row4">
                            <div class="crewPlayerBox" id="crew1Player4Box">
                                <div class="crewPlayerNameContainer" id="crew1Player4NameContainer">
                                    <span class="crewPlayerName crew1Player4Active crew1Player4Eliminated" id="crew1Player4NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew1Row5">
                            <div class="crewPlayerBox" id="crew1Player5Box">
                                <div class="crewPlayerNameContainer" id="crew1Player5NameContainer">
                                    <span class="crewPlayerName crew1Player5Active crew1Player5Eliminated" id="crew1Player5NameText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="crew" id="crew2">
                    <div class="crewBox" id="crew2Box">
                        <div class="crewRow" id="crew2Row0">
                            <div class="crewScoreBox" id="crew2ScoreBox">
                                <div class="crewScoreContainer" id="crew2ScoreContainer">
                                    <span class="crewStocksLeft" id="crew2StocksLeftText"></span>
                                </div>
                            </div>
                            <div class="crewNameBox" id="crew2NameBox">
                                <div class="crewNameContainer" id="crew1NameContainer">
                                    <span class="crewName" id="crew2NameText"></span>
                                </div>
                            </div>
                            <div class="crewPort" id="crew2Port">
                                <div class="crewCharacter" id="crew2Character"></div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew2Row1">
                            <div class="crewPlayerBox" id="crew2Player1Box">
                                <div class="crewPlayerNameContainer" id="crew2Player1NameContainer">
                                    <span class="crewPlayerName crew2Player1Active crew2Player1Eliminated" id="crew2Player1NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew2Row2">
                            <div class="crewPlayerBox" id="crew2Player2Box">
                                <div class="crewPlayerNameContainer" id="crew2Player2NameContainer">
                                    <span class="crewPlayerName crew2Player2Active crew2Player2Eliminated" id="crew2Player2NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew2Row3">
                            <div class="crewPlayerBox" id="crew2Player3Box">
                                <div class="crewPlayerNameContainer" id="crew2Player3NameContainer">
                                    <span class="crewPlayerName crew2Player3Active crew2Player3Eliminated" id="crew2Player3NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew2Row4">
                            <div class="crewPlayerBox" id="crew2Player4Box">
                                <div class="crewPlayerNameContainer" id="crew2Player4NameContainer">
                                    <span class="crewPlayerName crew2Player4Active crew2Player4Eliminated" id="crew2Player4NameText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="crewRow" id="crew2Row5">
                            <div class="crewPlayerBox" id="crew2Player5Box">
                                <div class="crewPlayerNameContainer" id="crew2Player5NameContainer">
                                    <span class="crewPlayerName crew2Player5Active crew2Player5Eliminated" id="crew2Player5NameText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="snackbar" id="snackbar"></div>
    </body>
</html>

<script type="text/javascript">
    $(document).ready(function () {
        fitty('.crewStocksLeft', { minSize: 8, maxSize: 40, multiLine: false });
        fitty('.crewName', { minSize: 8, maxSize: 28, multiLine: false });
        fitty('.crewPlayerName', { minSize: 8, maxSize: 28, multiLine: false });

        var uri = "ws://localhost:56613/WebSocket/Queu";

        websocket = new WebSocket(uri);

        websocket.onopen = function () {
            console.log("Connected to server.");
            var jsonData = { "type": "overlayConnected", "data": window.location.href };
            websocket.send(JSON.stringify(jsonData));
        };

        websocket.onerror = function (event) {
            showSnackbar("Something went wrong with the connection to the Queu WebSocket to receive live updates. If Livestream Production Manager is deployed to IIS, make sure there's no port like ':56613' defined after 'localhost' and IIS has WebSockets enabled.");

            console.log("Something went wrong with the WebSocket connection:");
            console.log(event);
        };

        websocket.onmessage = function (event) {
            console.log(event.data);

            var jsonData = JSON.parse(event.data);

            if (jsonData.type == "queu") {
                $.each(jsonData.data, function (i) {
                    $(jsonData.data[i]).addClass("changing");
                });

                setTimeout(function () {
                    var queryString = '?reload=' + new Date().getTime();
                    $('link[rel="stylesheet"]').not('link[href="css/styles.css"]').each(function () {
                        this.href = this.href.replace(/\?.*|$/, queryString);
                    });

                    fitty('.crewStocksLeft', { minSize: 8, maxSize: 35, multiLine: false });
                    fitty('.crewName', { minSize: 8, maxSize: 28, multiLine: false });
                    fitty('.crewPlayerName', { minSize: 8, maxSize: 28, multiLine: false });

                    $.each(jsonData.data, function (i) {
                        $(jsonData.data[i]).removeClass("changing").addClass("changed");
                    });

                    setTimeout(function () {
                        $.each(jsonData.data, function (i) {
                            $(jsonData.data[i]).removeClass("changed");
                        });
                    }, 500);
                }, 500);
            }
            else if (jsonData.type == "forceResize") {
                $(".crewStocksLeft").addClass("changing");
                $(".crewName").addClass("changing");
                $(".crewPlayerName").addClass("changing");
                setTimeout(function () {
                    fitty('.crewStockLeft', { minSize: 8, maxSize: 35, multiLine: false });
                    fitty('.crewName', { minSize: 8, maxSize: 28, multiLine: false });
                    fitty('.crewPlayerName', { minSize: 8, maxSize: 28, multiLine: false });

                    $(".crewStockLeft").removeClass("changing").addClass("changed");
                    $(".crewName").removeClass("changing").addClass("changed");
                    $(".crewPlayerName").removeClass("changing").addClass("changed");

                    setTimeout(function () {
                        $(".crewStockLeft").removeClass("changed");
                        $(".crewName").removeClass("changed");
                        $(".crewPlayerName").removeClass("changed");
                    }, 500);
                }, 500);
            }
        };
    });

    $(window).on("beforeunload", function () {
        var jsonData = { "type": "overlayDisconnected", "data": window.location.href };
        websocket.send(JSON.stringify(jsonData));
        websocket.close();
    });

    function showSnackbar(message) {
        $("#snackbar").html(message);

        var marginLeft = ($(window).width() - $("#snackbar").outerWidth()) / 2;
        $("#snackbar").css("left", marginLeft >= 0 ? marginLeft : 0);

        $("#snackbar").addClass("show");
        setTimeout(function () {
            $("#snackbar").removeClass("show");
        }, 9000);
    }
</script>